<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Multi-Agent HR System</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        .main-container {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            backdrop-filter: blur(10px);
            margin: 20px auto;
            max-width: 1200px;
        }
        
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            border-radius: 20px 20px 0 0;
            text-align: center;
        }
        
        .header h1 {
            font-size: 2.5rem;
            font-weight: 700;
            margin-bottom: 10px;
        }
        
        .header p {
            font-size: 1.1rem;
            opacity: 0.9;
        }
        
        .chat-container {
            height: 500px;
            overflow-y: auto;
            border: 1px solid #e0e0e0;
            border-radius: 15px;
            padding: 20px;
            margin: 20px;
            background: #fafafa;
        }
        
        .message {
            margin-bottom: 15px;
            display: flex;
            align-items: flex-start;
        }
        
        .message.user {
            justify-content: flex-end;
        }
        
        .message.agent {
            justify-content: flex-start;
        }
        
        .message-content {
            max-width: 70%;
            padding: 15px 20px;
            border-radius: 20px;
            word-wrap: break-word;
        }
        
        .message.user .message-content {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-bottom-right-radius: 5px;
        }
        
        .message.agent .message-content {
            background: white;
            border: 1px solid #e0e0e0;
            border-bottom-left-radius: 5px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .message-time {
            font-size: 0.8rem;
            opacity: 0.7;
            margin-top: 5px;
        }
        
        .input-container {
            padding: 20px;
            background: white;
            border-radius: 0 0 20px 20px;
        }
        
        .file-upload-area {
            border: 2px dashed #667eea;
            border-radius: 15px;
            padding: 20px;
            text-align: center;
            margin-bottom: 15px;
            background: #f8f9ff;
            transition: all 0.3s ease;
        }
        
        .file-upload-area:hover {
            border-color: #764ba2;
            background: #f0f2ff;
        }
        
        .file-upload-area.dragover {
            border-color: #764ba2;
            background: #e8ebff;
        }
        
        .uploaded-files {
            margin-top: 10px;
        }
        
        .file-item {
            display: inline-block;
            background: #667eea;
            color: white;
            padding: 5px 10px;
            border-radius: 15px;
            margin: 2px;
            font-size: 0.9rem;
        }
        
        .file-item .remove-file {
            margin-left: 8px;
            cursor: pointer;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border: none;
            border-radius: 25px;
            padding: 12px 30px;
            font-weight: 600;
            transition: all 0.3s ease;
        }
        
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }
        
        .loading {
            display: none;
            text-align: center;
            padding: 20px;
        }
        
        .spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
            margin: 0 auto 10px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .agent-info {
            background: #f8f9ff;
            border-radius: 15px;
            padding: 15px;
            margin: 20px;
            border-left: 4px solid #667eea;
        }
        
        .agent-info h5 {
            color: #667eea;
            margin-bottom: 10px;
        }
        
        .agent-badge {
            display: inline-block;
            background: #667eea;
            color: white;
            padding: 3px 8px;
            border-radius: 10px;
            font-size: 0.8rem;
            margin: 2px;
        }
        
        .chart-container {
            text-align: center;
            margin: 20px 0;
        }
        
        .chart-container img {
            max-width: 100%;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }
        
        /* CSS cho markdown images (donut charts) */
        .message-content img {
            max-width: 100%;
            height: auto;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            margin: 10px 0;
        }
        
        /* CSS cho confirmation dialog */
        .confirmation-dialog {
            background: linear-gradient(135deg, #fff, #f8f9fa);
            border: 2px solid #e9ecef;
            border-radius: 15px;
            padding: 20px;
            margin: 10px 0;
            box-shadow: 0 8px 25px rgba(0,0,0,0.1);
        }
        
        /* Table styling */
        .table-responsive {
            margin: 15px 0;
        }
        
        .table {
            font-size: 0.9rem;
            margin-bottom: 0;
        }
        
        .table th {
            background-color: #f8f9fa;
            font-weight: 600;
            border-top: none;
        }
        
        .table td {
            vertical-align: middle;
        }
        
        .table-striped tbody tr:nth-of-type(odd) {
            background-color: rgba(0,0,0,.02);
        }
        
        .table-hover tbody tr:hover {
            background-color: rgba(0,0,0,.075);
            max-width: 500px;
            margin-left: auto;
            margin-right: auto;
        }
        
        .confirmation-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 15px;
            color: #495057;
            font-size: 16px;
        }
        
        .confirmation-header i {
            color: #ffc107;
            font-size: 18px;
        }
        
        .confirmation-body {
            margin-bottom: 20px;
            color: #6c757d;
            line-height: 1.5;
            font-size: 14px;
        }
        
        .confirmation-buttons {
            display: flex;
            gap: 12px;
            justify-content: center;
        }
        
        .confirmation-buttons .btn {
            padding: 12px 24px;
            border-radius: 8px;
            font-weight: 600;
            transition: all 0.3s ease;
            border: none;
            cursor: pointer;
            font-size: 14px;
            min-width: 100px;
        }
        
        .confirmation-buttons .btn-success {
            background: linear-gradient(135deg, #28a745, #20c997);
            color: white;
        }
        
        .confirmation-buttons .btn-success:hover {
            background: linear-gradient(135deg, #218838, #1ea085);
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(40, 167, 69, 0.4);
        }
        
        .confirmation-buttons .btn-secondary {
            background: linear-gradient(135deg, #6c757d, #adb5bd);
            color: white;
        }
        
        .confirmation-buttons .btn-secondary:hover {
            background: linear-gradient(135deg, #5a6268, #9ca3af);
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(108, 117, 125, 0.4);
        }
    </style>
</head>
<body>
    <div class="container-fluid">
        <div class="main-container">
            <!-- Header -->
            <div class="header">
                <h1><i class="fas fa-robot"></i> Multi-Agent HR System</h1>
                <p>H·ªá th·ªëng AI Agent th√¥ng minh cho qu·∫£n l√Ω nh√¢n s·ª±</p>
            </div>
            
            <!-- Agent Info -->
            <div class="agent-info">
                <h5><i class="fas fa-info-circle"></i> C√°c Agent c√≥ s·∫µn:</h5>
                <span class="agent-badge">Orchestrator</span>
                <span class="agent-badge">Query Agent</span>
                <span class="agent-badge">CV Agent</span>
                <span class="agent-badge">Chart Agent</span>
                <span class="agent-badge">Analysis Agent</span>
                <span class="agent-badge">Conversational Agent</span>
            </div>
            
            <!-- Chat Container -->
            <div class="chat-container" id="chatContainer">
                <div class="message agent">
                    <div class="message-content">
                        <strong>ü§ñ HR Assistant:</strong> Ch√†o m·ª´ng b·∫°n ƒë·∫øn v·ªõi Multi-Agent HR System! T√¥i c√≥ th·ªÉ gi√∫p b·∫°n:
                        <br>‚Ä¢ Truy v·∫•n d·ªØ li·ªáu nh√¢n s·ª±
                        <br>‚Ä¢ Ph√¢n t√≠ch CV v√† ·ª©ng vi√™n
                        <br>‚Ä¢ T·∫°o bi·ªÉu ƒë·ªì th·ªëng k√™
                        <br>‚Ä¢ T·ªïng h·ª£p b√°o c√°o
                        <br><br>H√£y nh·∫≠p y√™u c·∫ßu c·ªßa b·∫°n ho·∫∑c upload file PDF ƒë·ªÉ b·∫Øt ƒë·∫ßu!
                        <div class="message-time">H·ªá th·ªëng s·∫µn s√†ng</div>
                    </div>
                </div>
            </div>
            
            <!-- Loading -->
            <div class="loading" id="loading">
                <div class="spinner"></div>
                <p>ƒêang x·ª≠ l√Ω y√™u c·∫ßu...</p>
            </div>
            
            <!-- Input Container -->
            <div class="input-container">
                <!-- File Upload Area -->
                <div class="file-upload-area" id="fileUploadArea">
                    <i class="fas fa-cloud-upload-alt fa-2x text-primary mb-3"></i>
                    <h5>Upload file PDF (CV)</h5>
                    <p class="text-muted">K√©o th·∫£ file PDF v√†o ƒë√¢y ho·∫∑c click ƒë·ªÉ ch·ªçn file</p>
                    <input type="file" id="fileInput" accept=".pdf" multiple style="display: none;">
                    <button type="button" class="btn btn-outline-primary" onclick="document.getElementById('fileInput').click()">
                        <i class="fas fa-plus"></i> Ch·ªçn file
                    </button>
                </div>
                
                <!-- Uploaded Files -->
                <div class="uploaded-files" id="uploadedFiles"></div>
                
                <!-- Input Form -->
                <div class="input-group">
                    <input type="text" class="form-control" id="userInput" placeholder="Nh·∫≠p y√™u c·∫ßu c·ªßa b·∫°n..." style="border-radius: 25px 0 0 25px; border-right: none;">
                    <button class="btn btn-primary" type="button" id="sendButton" style="border-radius: 0 25px 25px 0;">
                        <i class="fas fa-paper-plane"></i> G·ª≠i
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script>
        let uploadedFiles = [];
        
        // File upload handling
        const fileInput = document.getElementById('fileInput');
        const fileUploadArea = document.getElementById('fileUploadArea');
        const uploadedFilesDiv = document.getElementById('uploadedFiles');
        
        fileInput.addEventListener('change', handleFileSelect);
        
        // Drag and drop
        fileUploadArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            fileUploadArea.classList.add('dragover');
        });
        
        fileUploadArea.addEventListener('dragleave', () => {
            fileUploadArea.classList.remove('dragover');
        });
        
        fileUploadArea.addEventListener('drop', (e) => {
            e.preventDefault();
            fileUploadArea.classList.remove('dragover');
            const files = Array.from(e.dataTransfer.files);
            handleFiles(files);
        });
        
        function handleFileSelect(e) {
            const files = Array.from(e.target.files);
            handleFiles(files);
        }
        
        function handleFiles(files) {
            files.forEach(file => {
                if (file.type === 'application/pdf') {
                    uploadFile(file);
                } else {
                    alert('Ch·ªâ cho ph√©p file PDF!');
                }
            });
        }
        
        function uploadFile(file) {
            const formData = new FormData();
            formData.append('file', file);
            
            fetch('/api/upload', {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    uploadedFiles.push(data.filename);
                    displayUploadedFiles();
                } else {
                    alert('L·ªói upload: ' + data.error);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('L·ªói upload file!');
            });
        }
        
        function displayUploadedFiles() {
            uploadedFilesDiv.innerHTML = uploadedFiles.map(filename => 
                `<span class="file-item">
                    <i class="fas fa-file-pdf"></i> ${filename}
                    <span class="remove-file" onclick="removeFile('${filename}')">√ó</span>
                </span>`
            ).join('');
        }
        
        function removeFile(filename) {
            uploadedFiles = uploadedFiles.filter(f => f !== filename);
            displayUploadedFiles();
        }
        
        // Send message
        const sendButton = document.getElementById('sendButton');
        const userInput = document.getElementById('userInput');
        const chatContainer = document.getElementById('chatContainer');
        const loading = document.getElementById('loading');
        
        sendButton.addEventListener('click', sendMessage);
        userInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                sendMessage();
            }
        });
        
        function sendMessage() {
            const message = userInput.value.trim();
            if (!message) return;
            
            // Add user message to chat
            addMessage(message, 'user');
            userInput.value = '';
            
            // Show loading
            loading.style.display = 'block';
            chatContainer.scrollTop = chatContainer.scrollHeight;
            
            // Send request
            fetch('/api/process', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    input: message,
                    files: uploadedFiles
                })
            })
            .then(response => response.json())
            .then(data => {
                loading.style.display = 'none';
                
                if (data.error) {
                    addMessage('L·ªói: ' + data.error, 'agent');
                } else {
                    // Display result
                    displayResult(data);
                }
            })
            .catch(error => {
                loading.style.display = 'none';
                console.error('Error:', error);
                addMessage('L·ªói k·∫øt n·ªëi: ' + error.message, 'agent');
            });
        }
        
        function addMessage(content, sender) {
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${sender}`;
            
            const time = new Date().toLocaleTimeString('vi-VN');
            
            const html = (window.marked && typeof marked.parse === 'function') ? marked.parse(content) : content;
            messageDiv.innerHTML = `
                <div class="message-content">
                    ${html}
                    <div class="message-time">${time}</div>
                </div>
            `;
            
            chatContainer.appendChild(messageDiv);
            chatContainer.scrollTop = chatContainer.scrollHeight;
        }
        
        function addConfirmationButtons() {
            const chatContainer = document.getElementById('chatContainer');
            const buttonDiv = document.createElement('div');
            buttonDiv.className = 'message user';
            buttonDiv.innerHTML = `
                <div class="message-content">
                    <div class="confirmation-dialog">
                        <div class="confirmation-header">
                            <i class="fas fa-exclamation-triangle"></i>
                            <strong>X√°c nh·∫≠n h√†nh ƒë·ªông</strong>
                        </div>
                        <div class="confirmation-body">
                            B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën qu√©t to√†n b·ªô CV trong h·ªá th·ªëng kh√¥ng? 
                            H√†nh ƒë·ªông n√†y s·∫Ω ph√¢n t√≠ch t·∫•t c·∫£ CV c√≥ s·∫µn v√† c√≥ th·ªÉ m·∫•t th·ªùi gian.
                        </div>
                        <div class="confirmation-buttons">
                            <button class="btn btn-success" onclick="confirmAction(true)">
                                <i class="fas fa-check"></i> Accept
                            </button>
                            <button class="btn btn-secondary" onclick="confirmAction(false)">
                                <i class="fas fa-times"></i> Cancel
                            </button>
                        </div>
                    </div>
                </div>
            `;
            
            chatContainer.appendChild(buttonDiv);
            chatContainer.scrollTop = chatContainer.scrollHeight;
        }
        
        function confirmAction(confirmed) {
            if (confirmed) {
                // G·ª≠i l·∫°i request v·ªõi confirmation
                sendMessage('C√≥, qu√©t to√†n b·ªô CV');
            } else {
                addMessage('ƒê√£ h·ªßy b·ªè y√™u c·∫ßu qu√©t CV.', 'agent');
            }
        }
        
        function addRateLimitWarning(content) {
            const warningHtml = `
                <div class="alert alert-warning" role="alert">
                    <i class="fas fa-exclamation-triangle"></i>
                    <strong>C·∫£nh b√°o Rate Limit:</strong> H·ªá th·ªëng ƒë√£ ƒë·∫°t gi·ªõi h·∫°n API calls. 
                    M·ªôt s·ªë ph√¢n t√≠ch c√≥ th·ªÉ kh√¥ng ho√†n th√†nh. Vui l√≤ng th·ª≠ l·∫°i sau 1-2 ph√∫t.
                </div>
            `;
            return warningHtml + content;
        }
        
        function displayResult(data) {
            let response = '';
            
            // Ki·ªÉm tra n·∫øu c·∫ßn x√°c nh·∫≠n
            if (data.confirmation_required) {
                response = data.confirmation_message;
                addMessage(response, 'agent');
                // Th√™m n√∫t x√°c nh·∫≠n
                addConfirmationButtons();
                return;
            }
            
            // Ki·ªÉm tra n·∫øu l√† conversational response
            if (data.conversational_response) {
                response = data.conversational_response;
                addMessage(response, 'agent');
                return;
            }
            
            if (data.orchestrator_analysis) {
                const analysis = data.orchestrator_analysis;
                response += `### üéØ Ph√¢n t√≠ch Intent\n`;
                response += `- **Intent**: ${analysis.intent_analysis?.primary_intent || 'N/A'}\n`;
                response += `- **ƒê·ªô tin c·∫≠y**: ${(analysis.intent_analysis?.confidence * 100 || 0).toFixed(1)}%\n`;
                response += `- **Agents**: ${(analysis.intent_analysis?.required_agents||[]).join(', ') || 'N/A'}\n\n`;
            }
            
            if (data.agent_results && data.agent_results.length > 0) {
                // N·∫øu query_agent c√≥ final_answer ‚Üí ∆∞u ti√™n hi·ªÉn th·ªã nh∆∞ c√¢u tr·∫£ l·ªùi
                const q = data.agent_results.find(r => r.agent === 'query_agent');
                const finalAnswer = q?.result?.final_answer || q?.final_answer;
                if (finalAnswer) {
                    response += `### ‚úÖ Tr·∫£ l·ªùi\n${finalAnswer}\n\n`;
                } else {
                    response += `### üìã K·∫øt qu·∫£ th·ª±c thi\n`;
                    data.agent_results.forEach((result, index) => {
                        response += `- **B∆∞·ªõc ${result.step}**: ${result.agent} - ${result.status}\n`;
                    });
                    response += `\n`;
                }
            }
            
            if (data.analysis_result && data.analysis_result.result) {
                const analysisResult = data.analysis_result.result;
                console.log('Analysis result:', analysisResult);
                if (analysisResult.formatted_summary) {
                    console.log('Adding formatted_summary to response');
                    console.log('Formatted summary length:', analysisResult.formatted_summary.length);
                    console.log('Formatted summary preview:', analysisResult.formatted_summary.substring(0, 200));
                    // Th√™m tr·ª±c ti·∫øp formatted_summary m√† kh√¥ng c·∫ßn header th√™m
                    response += analysisResult.formatted_summary + '\n\n';
                } else if (analysisResult.markdown) {
                    console.log('Adding markdown to response');
                    response += analysisResult.markdown + '\n\n';
                } else if (analysisResult.ai_analysis) {
                    console.log('Adding ai_analysis to response');
                    response += `### üß† Ph√¢n t√≠ch AI\n${analysisResult.ai_analysis}\n\n`;
                }
            }
            
            // Helper render b·∫£ng d·ªØ li·ªáu
            const renderTable = (tbl) => {
                if (!tbl || !tbl.columns || !tbl.data) return '';
                const cols = tbl.columns;
                const rows = tbl.data.slice(0, 10);
                let html = '<div class="table-responsive"><table class="table table-sm table-bordered">';
                html += '<thead class="table-light"><tr>' + cols.map(c => `<th>${c}</th>`).join('') + '</tr></thead>';
                html += '<tbody>' + rows.map(r => `<tr>${r.map(c => `<td>${c ?? ''}</td>`).join('')}</tr>`).join('') + '</tbody>';
                html += '</table></div>';
                if (tbl.data.length > 10) html += `<div class="text-muted" style="font-size: 0.9rem;">Hi·ªÉn th·ªã 10 d√≤ng ƒë·∫ßu (t·ªïng ${tbl.data.length} d√≤ng)</div>`;
                return html;
            };

            // Charts + b·∫£ng d·ªØ li·ªáu ƒë·∫ßu ti√™n n·∫øu c√≥
            if (data.agent_results) {
                let shownTable = false;
                data.agent_results.forEach(result => {
                    // chart
                    try {
                        const chartInfo = result?.result?.result?.chart_info;
                        if (chartInfo && chartInfo.chart_file) {
                            const fname = String(chartInfo.chart_file).split(/[\\/]/).pop();
                            response += `<div class="chart-container">
                                <strong>üìä Bi·ªÉu ƒë·ªì ƒë√£ t·∫°o:</strong><br>
                                <img src="/api/charts/${fname}" alt="Chart" style="max-width: 100%; margin-top: 10px;">
                            </div>`;
                        }
                    } catch (e) {}

                    // table
                    if (!shownTable) {
                        const table1 = result?.result?.result;
                        if (table1 && table1.columns && table1.data) {
                            response += `<strong>üìë D·ªØ li·ªáu k·∫øt qu·∫£:</strong>`;
                            response += renderTable(table1);
                            shownTable = true;
                        }
                    }
                });
            }
            
            if (!response) {
                response = '‚úÖ ƒê√£ x·ª≠ l√Ω y√™u c·∫ßu th√†nh c√¥ng! (Kh√¥ng c√≥ d·ªØ li·ªáu hi·ªÉn th·ªã)';
            }
            
            console.log('Final response length:', response.length);
            console.log('Final response preview:', response.substring(0, 500));
            
            // Check for rate limit errors and add warning
            if (response.includes('429') || response.includes('Rate limit') || response.includes('RATE LIMIT')) {
                response = addRateLimitWarning(response);
            }
            
            addMessage(response, 'agent');
        }
    </script>
</body>
</html>
